## Homework Assignment 3

Due Tuesday, May. 4, 2021 at 9:00 am

2019314211 Minhyun Lee



### 1. Implement Poisson Blending (100 points)

The purpose of this assignment is to explore **gradient-domain processing**, and in particular **Poisson blending**.

#### Toy problem (20 points)

For this problem, I start with a toy example using the image `toy_problem.png` in the `./data` directory. As described in `HINT AND INFORMATION`, I **compute the** **x and y gradient of an image s**, then use these the gradients, plus **one pixel intensity**, to **reconstruct an image v**. The result is shown below.

```matlab
function [ im_out ] = toy_reconstruct( im_in )

    imwrite(im_in, 'results/toy_ori.png');

    [imh, imw, nn] = size(im_in);
    % map each pixel in the region S to a variable number
    Im2var = zeros(imh, imw);
    Im2var(1:imh*imw) = 1: imh*imw;

    M = 2 * imh * imw + 1;
    N = imh * imw;

    % sparse matrix A
    A = sparse([], [], [], M, N);
    % known vector b
    b = zeros(M, 1);

    % the objectivity of Equation (2) in A3.pdf
    e = 1;
    for y = 1:imh
        for x = 1:imw-1
            A(e, Im2var(y,x+1)) = 1;
            A(e, Im2var(y,x)) = -1;
            b(e) = im_in(y,x+1)-im_in(y,x);  
            e = e+1;
        end  
    end    

    % the objectivity of Equation (3) in A3.pdf
    for y = 1:imh-1
        for x = 1:imw
            A(e, Im2var(y+1,x)) = 1;
            A(e, Im2var(y,x)) = -1;
            b(e) = im_in(y+1,x)-im_in(y,x);  
            e = e+1;
        end  
    end
    
    % the objectivity of Equation (4) in A3.pdf
    A(e, Im2var(1,1)) = 1;
    b(e) = im_in(1,1);

    % the variable to be solved
    v = A\b;
    im_out = reshape(v, [imh, imw]);
    imwrite(im_out, 'results/toy_recon.png');
    
end
```

#### Result

#### ![](https://github.com/gaviotas/cp_project/blob/main/A3/figure/fig_toy_example.png?raw=true)

```
Error: 9.4139e-07
```



#### Poisson blending (50 points)

For Poisson blending, I use the images `hiking.png`, `penguin.png`, and `penguin-chick.png`. Then, I implement the function `poissonBlend.m`  along the three steps provided. To select the boundaries of a region in the source image and specify a location in the target image, I use the functions `getMask.m` and `alignSource.m` provided in the `./src` directory. Using **Laplacian filter**, I formulate and **solve the blending constraints** expressed in **Equation (1)**. The results are shown below.

```matlab
function [ im_blend ] = poissonBlend( im_s, mask_s, im_background )

    [imh, imw, nn] = size(im_s);
    Im2var = zeros(imh, imw);

    % the region S to be pasted
    [yy xx] = find(mask_s > 0);
    % the number of pixels in the region S (non-zero pixels in mask_s)
    nz = sum(sum(mask_s));

    % map each pixel in the region S to a variable number
    e = 1;
    for i = 1:nz
        Im2var(yy(i),xx(i)) = e;
        e = e+1;
    end
    
    % sparse matrix A
    A = sparse([], [], []);
    % known vector b
    b = zeros(nz, nn);

    e = 1;

    im_blend = im_background; 

    dx = [0, 0, -1, +1];
    dy = [-1, +1, 0, 0];

    % Laplacian filter
    for i = 1:nz
        y = yy(i);
        x = xx(i);
        A(e, Im2var(y,x)) = 4;
        for j = 1:4
            % the part of the first summation of Equation (1) in A3.pdf
            if mask_s(y+dy(j),x+dx(j)) == 1
                A(e, Im2var(y+dy(j),x+dx(j))) = -1;
                grad_s = reshape(im_s(y,x,:) - im_s(y+dy(j),x+dx(j),:), 1, nn);
                b(e,:) = b(e,:) + grad_s;
            % the part of the second summation of Equation (1) in A3.pdf
            else
                grad_s = reshape(im_s(y,x,:) - im_s(y+dy(j),x+dx(j),:), 1, nn);
                b(e,:) = b(e,:) + grad_s + reshape(im_background(y+dy(j),x+dx(j),:), 1, nn);
            end

        end
        e = e+1;
    end
    
    % the variable to be solved
    v = A\b;

    % reconstruct the blended image
    e = 1;
    for i=1:nz
        y = yy(i);
        x = xx(i);
        im_blend(y,x,:) = v(e,:);
        e = e + 1;
    end
    
    % save the results
    imwrite(im_s, 'results/poisson blending/im_s.png');
    imwrite(mask_s, 'results/poisson blending/mask_s.png');
    imwrite(im_background, 'results/poisson blending/im_background.png');    
    imwrite(im_blend, 'results/poisson blending/im_blend.png');
        
end
```

#### Result

![fig_poisson_blending](https://github.com/gaviotas/cp_project/blob/main/A3/figure/fig_poisson_blending.png?raw=true)

#### Blending with mixed gradients (10 points)

Follow the same steps as Poisson blending, but use the gradient in source or target with the larger magnitude, I implement the function `mixedBlend.m` . For that, I compute the gradient in source (`grad_s`) and in target (`grad_t`), compare their magnitudes and use the gradient with the larger magnitude as the guide. The remains are same with Poisson blending. The results are shown below.

```matlab
function [ im_blend ] = mixedBlend( im_s, mask_s, im_background )

    [imh, imw, nn] = size(im_s);
    Im2var = zeros(imh, imw);

    % the region S to be pasted
    [yy xx] = find(mask_s > 0);
    % the number of pixels in the region S (non-zero pixels in mask_s)
    nz = sum(sum(mask_s));

    % map each pixel in the region S to a variable number
    e = 1;
    for i = 1:nz
        Im2var(yy(i),xx(i)) = e;
        e = e+1;
    end
    
    % sparse matrix A
    A = sparse([], [], []);
    % known vector b
    b = zeros(nz, nn);

    e = 1;

    im_blend = im_background; 

    dx = [0, 0, -1, +1];
    dy = [-1, +1, 0, 0];
    
    % Laplacian filter
    for i = 1:nz
        y = yy(i);
        x = xx(i);
        A(e, Im2var(y,x)) = 4;
        for j = 1:4
            % the part of the first summation of Equation (1) in A3.pdf
            if mask_s(y+dy(j),x+dx(j)) == 1
                A(e, Im2var(y+dy(j),x+dx(j))) = -1;
                grad_s = reshape(im_s(y,x,:) - im_s(y+dy(j),x+dx(j),:), 1, nn);
                grad_t = reshape(im_background(y,x,:) - im_background(y+dy(j),x+dx(j),:), 1, nn);
                % the mixed gradients variant
                if abs(grad_s) > abs(grad_t)
                    grad_d = grad_s;
                else
                    grad_d = grad_t;
                end
                b(e,:) = b(e,:) + grad_d;
            % the part of the second summation of Equation (1) in A3.pdf
            else
                grad_s = reshape(im_s(y,x,:) - im_s(y+dy(j),x+dx(j),:), 1, nn);
                grad_t = reshape(im_background(y,x,:) - im_background(y+dy(j),x+dx(j),:), 1, nn);
                % the mixed gradients variant
                if abs(grad_s) > abs(grad_t)
                    grad_d = grad_s;
                else
                    grad_d = grad_t;
                end
                b(e,:) = b(e,:) + grad_d + reshape(im_background(y+dy(j),x+dx(j),:), 1, nn);
            end

        end
        e = e+1;
    end
    
    % the variable to be solved
    v = A\b;

    % reconstruct the blended image
    e = 1;
    for i=1:nz
        y = yy(i);
        x = xx(i);
        im_blend(y,x,:) = v(e,:);
        e = e + 1;
    end
    
    % save the results
    imwrite(im_s, 'results/mixed gradients/im_s.png');
    imwrite(mask_s, 'results/mixed gradients/mask_s.png');
    imwrite(im_background, 'results/mixed gradients/im_background.png');    
    imwrite(im_blend, 'results/mixed gradients/im_blend.png');

end
```

#### Result

![fig_mixed_gradients](https://raw.githubusercontent.com/gaviotas/cp_project/main/A3/figure/fig_mixed_gradients.png)

#### Your own examples (20 points)

In this section, I apply Poisson blending and mixed gradients variant to my own examples. The results are shown below and there are some failure cases: 1) **weired colors** when the background color difference between the source and target image is large (2nd row), 2) **blurred boundaries** (Poisson blending cases in 3rd and 4th rows) or 3) **disappearing object** when the background image has a complex texture (mixed gradients case in 3rd row).

#### Result

![fig_own_examples](https://github.com/gaviotas/cp_project/blob/main/A3/figure/fig_own_examples.png?raw=true)

